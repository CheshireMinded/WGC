<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Results Tracker</title>
  <link rel="stylesheet" href="../src/styles/styles.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: white;
    }

    .container {
      background: #16213e;
      padding: 30px;
      border-radius: 15px;
      border: 1px solid #333;
    }

    h1 {
      text-align: center;
      color: #64b5f6;
      margin-bottom: 30px;
    }

    .section {
      background: #0f3460;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .input-with-button {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }

    .input-with-button input {
      flex: 1;
      padding: 10px;
      border: 1px solid #555;
      border-radius: 5px;
      background: #2a2a3e;
      color: white;
      font-size: 16px;
    }

    .troop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .troop-card {
      background: #1e3a8a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #3b82f6;
    }

    .troop-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .troop-header h4 {
      margin: 0;
      color: white;
    }

    .troop-card input {
      width: 100%;
      padding: 8px;
      border: 1px solid #555;
      border-radius: 3px;
      background: #2a2a3e;
      color: white;
      text-align: center;
      margin-bottom: 10px;
    }

    .troop-card .label {
      font-size: 0.9em;
      color: #ccc;
      margin-bottom: 5px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }

    button:hover {
      background: #2563eb;
    }

    button.success {
      background: #10b981;
    }

    button.danger {
      background: #ef4444;
    }

    button.secondary {
      background: #6b7280;
    }

    .add-button {
      background: #10b981;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }

    .add-button:hover {
      background: #059669;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .results-display {
      background: #374151;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .results-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #4b5563;
    }

    .history-section {
      margin-top: 30px;
    }

    .history-item {
      background: #374151;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #3b82f6;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .history-date {
      color: #9ca3af;
      font-size: 0.9em;
    }

    .history-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .stat-item {
      background: #4b5563;
      padding: 8px;
      border-radius: 5px;
      text-align: center;
    }

    .stat-label {
      font-size: 0.8em;
      color: #9ca3af;
    }

    .stat-value {
      font-weight: bold;
      color: white;
    }

    .clear-history {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 15px;
    }

    .clear-history:hover {
      background: #dc2626;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
      }

      .troop-grid {
        grid-template-columns: 1fr;
      }

      .results-grid {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .input-with-button {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>‚öîÔ∏è Battle Results Tracker</h1>

    <div class="section">
      <h3>Battle Information</h3>
      <div class="input-group">
        <label for="battleName">Battle/Control Point Name:</label>
        <input type="text" id="battleName" placeholder="e.g., Control Point Alpha" />
      </div>
      <div class="input-group">
        <label for="battleDate">Date:</label>
        <input type="date" id="battleDate" />
      </div>
      <div class="input-group">
        <label for="battleAgainst">Against:</label>
        <div class="input-with-button">
          <select id="battleAgainst" onchange="handleEnemySelection()">
            <option value="">Select enemy or add new...</option>
          </select>
          <button type="button" onclick="addNewEnemy()" class="add-button">+ Add New</button>
        </div>
      </div>
          </div>
          
    <div class="section">
      <h3>Troops Sent (From Calculator)</h3>
      <div class="troop-grid">
        <div class="troop-card">
          <div class="troop-header">
            <h4>ü™ñ Army</h4>
          </div>
          <div class="label">Troops Sent:</div>
          <input type="number" id="armySent" placeholder="0" min="0" />
        </div>

        <div class="troop-card">
          <div class="troop-header">
            <h4>‚öì Marines</h4>
          </div>
          <div class="label">Troops Sent:</div>
          <input type="number" id="marinesSent" placeholder="0" min="0" />
          </div>
          
        <div class="troop-card">
          <div class="troop-header">
            <h4>‚úàÔ∏è Air Force</h4>
          </div>
          <div class="label">Troops Sent:</div>
          <input type="number" id="airforceSent" placeholder="0" min="0" />
        </div>
      </div>
          </div>
          
    <div class="section">
      <h3>Enemy Troops</h3>
      <div class="input-group">
        <label>
          <input type="checkbox" id="enemyFromCalculator" onchange="toggleEnemyTroopsSource()" />
          Enemy troops sent from calculator
        </label>
      </div>
      <div class="troop-grid">
        <div class="troop-card">
          <div class="troop-header">
            <h4>ü™ñ Enemy Army</h4>
          </div>
          <div class="label">Enemy Troops:</div>
          <input type="number" id="enemyArmySent" placeholder="0" min="0" />
        </div>

        <div class="troop-card">
          <div class="troop-header">
            <h4>‚öì Enemy Marines</h4>
          </div>
          <div class="label">Enemy Troops:</div>
          <input type="number" id="enemyMarinesSent" placeholder="0" min="0" />
          </div>
          
        <div class="troop-card">
          <div class="troop-header">
            <h4>‚úàÔ∏è Enemy Air Force</h4>
          </div>
          <div class="label">Enemy Troops:</div>
          <input type="number" id="enemyAirforceSent" placeholder="0" min="0" />
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Battle Results</h3>
      <div class="troop-grid">
        <div class="troop-card">
          <div class="troop-header">
            <h4>ü™ñ Army Losses</h4>
          </div>
          <div class="label">Troops Lost:</div>
          <input type="number" id="armyLost" placeholder="0" min="0" />
          <div class="label">Survivors:</div>
          <input type="number" id="armySurvived" placeholder="0" min="0" readonly />
        </div>

        <div class="troop-card">
          <div class="troop-header">
            <h4>‚öì Marines Losses</h4>
          </div>
          <div class="label">Troops Lost:</div>
          <input type="number" id="marinesLost" placeholder="0" min="0" />
          <div class="label">Survivors:</div>
          <input type="number" id="marinesSurvived" placeholder="0" min="0" readonly />
        </div>

        <div class="troop-card">
          <div class="troop-header">
            <h4>‚úàÔ∏è Air Force Losses</h4>
          </div>
          <div class="label">Troops Lost:</div>
          <input type="number" id="airforceLost" placeholder="0" min="0" />
          <div class="label">Survivors:</div>
          <input type="number" id="airforceSurvived" placeholder="0" min="0" readonly />
        </div>
      </div>

      <div class="input-group">
        <label for="battleOutcome">Battle Outcome:</label>
        <select id="battleOutcome" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 5px; background: #2a2a3e; color: white;">
          <option value="victory">üèÜ Victory</option>
          <option value="defeat">üíÄ Defeat</option>
          <option value="draw">ü§ù Draw</option>
        </select>
      </div>

      <div class="input-group">
        <label for="battleNotes">Battle Notes:</label>
        <textarea id="battleNotes" placeholder="Additional notes about the battle..." style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 5px; background: #2a2a3e; color: white; min-height: 80px; resize: vertical;"></textarea>
      </div>
    </div>

    <div class="button-group">
      <button onclick="editBattle()" class="secondary">‚úèÔ∏è Edit</button>
      <button onclick="saveBattle()" class="success">üíæ Save Battle Results</button>
      <button onclick="exportToCSV()" class="secondary">üìä Export to CSV</button>
      <button onclick="showEnemyAnalytics()" class="secondary">‚öîÔ∏è Enemy Analytics</button>
      <button onclick="goToTroopSwap()" class="secondary">üîÑ Troop Swap Calculator</button>
      <button onclick="clearForm()" class="secondary">üóëÔ∏è Clear Form</button>
      <button onclick="loadFromCalculator()" class="secondary">üìã Load from Calculator</button>
    </div>

    <div class="results-display" id="resultsDisplay" style="display: none;">
      <h3>üìä Battle Summary</h3>
      <div class="results-grid">
        <div class="results-row">
          <span>Total Sent:</span>
          <span id="totalSent">0</span>
        </div>
        <div class="results-row">
          <span>Total Lost:</span>
          <span id="totalLost">0</span>
        </div>
        <div class="results-row">
          <span>Total Survivors:</span>
          <span id="totalSurvived">0</span>
        </div>
        <div class="results-row">
          <span>Loss Rate:</span>
          <span id="lossRate">0%</span>
        </div>
      </div>
    </div>

    <div class="history-section">
      <h3>üìö Battle History</h3>
      <div id="battleHistory"></div>
      <button class="clear-history" onclick="clearHistory()">Clear All History</button>
    </div>
  </div>

  <script>
    // Set today's date as default
    document.getElementById('battleDate').value = new Date().toISOString().split('T')[0];

    // Auto-calculate survivors when losses are entered
    document.getElementById('armyLost').addEventListener('input', calculateSurvivors);
    document.getElementById('marinesLost').addEventListener('input', calculateSurvivors);
    document.getElementById('airforceLost').addEventListener('input', calculateSurvivors);

    function calculateSurvivors() {
      const armySent = parseInt(document.getElementById('armySent').value) || 0;
      const marinesSent = parseInt(document.getElementById('marinesSent').value) || 0;
      const airforceSent = parseInt(document.getElementById('airforceSent').value) || 0;

      const armyLost = parseInt(document.getElementById('armyLost').value) || 0;
      const marinesLost = parseInt(document.getElementById('marinesLost').value) || 0;
      const airforceLost = parseInt(document.getElementById('airforceLost').value) || 0;

      // Calculate survivors (can't be negative)
      const armySurvived = Math.max(0, armySent - armyLost);
      const marinesSurvived = Math.max(0, marinesSent - marinesLost);
      const airforceSurvived = Math.max(0, airforceSent - airforceLost);

      document.getElementById('armySurvived').value = armySurvived;
      document.getElementById('marinesSurvived').value = marinesSurvived;
      document.getElementById('airforceSurvived').value = airforceSurvived;

      // Update summary
      updateSummary();
    }

    function updateSummary() {
      const armySent = parseInt(document.getElementById('armySent').value) || 0;
      const marinesSent = parseInt(document.getElementById('marinesSent').value) || 0;
      const airforceSent = parseInt(document.getElementById('airforceSent').value) || 0;

      const armyLost = parseInt(document.getElementById('armyLost').value) || 0;
      const marinesLost = parseInt(document.getElementById('marinesLost').value) || 0;
      const airforceLost = parseInt(document.getElementById('airforceLost').value) || 0;

      const totalSent = armySent + marinesSent + airforceSent;
      const totalLost = armyLost + marinesLost + airforceLost;
      const totalSurvived = totalSent - totalLost;
      const lossRate = totalSent > 0 ? ((totalLost / totalSent) * 100).toFixed(1) : 0;

      document.getElementById('totalSent').textContent = totalSent.toLocaleString();
      document.getElementById('totalLost').textContent = totalLost.toLocaleString();
      document.getElementById('totalSurvived').textContent = totalSurvived.toLocaleString();
      document.getElementById('lossRate').textContent = lossRate + '%';

      document.getElementById('resultsDisplay').style.display = 'block';
    }

    function generateBattleName() {
      const date = new Date();
      const dateStr = date.toLocaleDateString();
      const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      // Get total troops sent for context
      const armySent = parseInt(document.getElementById('armySent').value) || 0;
      const marinesSent = parseInt(document.getElementById('marinesSent').value) || 0;
      const airforceSent = parseInt(document.getElementById('airforceSent').value) || 0;
      const totalSent = armySent + marinesSent + airforceSent;
      
      if (totalSent > 0) {
        return `Battle ${dateStr} ${timeStr} (${totalSent.toLocaleString()} troops)`;
      } else {
        return `Battle ${dateStr} ${timeStr}`;
      }
    }

    function saveBattle() {
      // Get calculator context if available
      const calculatorData = JSON.parse(localStorage.getItem('lastCalculatorData') || '{}');
      
      const battleData = {
      id: Date.now(),
        name: document.getElementById('battleName').value || generateBattleName(),
        date: document.getElementById('battleDate').value,
        against: document.getElementById('battleAgainst').value || 'Unknown Enemy',
        troopsSent: {
          army: parseInt(document.getElementById('armySent').value) || 0,
          marines: parseInt(document.getElementById('marinesSent').value) || 0,
          airforce: parseInt(document.getElementById('airforceSent').value) || 0
        },
        troopsLost: {
          army: parseInt(document.getElementById('armyLost').value) || 0,
          marines: parseInt(document.getElementById('marinesLost').value) || 0,
          airforce: parseInt(document.getElementById('airforceLost').value) || 0
        },
        troopsSurvived: {
          army: parseInt(document.getElementById('armySurvived').value) || 0,
          marines: parseInt(document.getElementById('marinesSurvived').value) || 0,
          airforce: parseInt(document.getElementById('airforceSurvived').value) || 0
        },
        enemyTroops: {
          army: parseInt(document.getElementById('enemyArmySent').value) || 0,
          marines: parseInt(document.getElementById('enemyMarinesSent').value) || 0,
          airforce: parseInt(document.getElementById('enemyAirforceSent').value) || 0
        },
        enemyFromCalculator: document.getElementById('enemyFromCalculator').checked,
        outcome: document.getElementById('battleOutcome').value,
        notes: document.getElementById('battleNotes').value,
        // Calculator input context
        calculatorInput: {
          troopsToUse: calculatorData.troopsToUse || 0,
          armyPercentage: calculatorData.armyPercentage || 0,
          marinesPercentage: calculatorData.marinesPercentage || 0,
          airforcePercentage: calculatorData.airforcePercentage || 0,
          remainingTroops: calculatorData.remainingTroops || 0
        }
      };

      // Get existing history
      let history = JSON.parse(localStorage.getItem('battleHistory') || '[]');
    
    // Add new battle
      history.unshift(battleData);
      
      // Keep only last 50 battles
      if (history.length > 50) {
        history = history.slice(0, 50);
      }
    
    // Save to localStorage
      localStorage.setItem('battleHistory', JSON.stringify(history));
      
      // Refresh history display
      displayHistory();
      
      // Show success message
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '‚úÖ Saved!';
      button.classList.add('success');
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('success');
      }, 2000);
      
      // Notify control point page of new battle data for counter strategy updates
      notifyCounterStrategyUpdate(battleData);
    }

    function displayHistory() {
      const history = JSON.parse(localStorage.getItem('battleHistory') || '[]');
      const historyContainer = document.getElementById('battleHistory');
      
      if (history.length === 0) {
        historyContainer.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">No battle history yet. Save your first battle to see it here!</p>';
      return;
    }
    
      historyContainer.innerHTML = history.map(battle => `
        <div class="history-item">
          <div class="history-header">
            <h4>${battle.name}</h4>
            <span class="history-date">${new Date(battle.date).toLocaleDateString()}</span>
          </div>
          ${battle.against ? `<div class="history-enemy" style="color: #fbbf24; font-weight: bold; margin-bottom: 8px;">‚öîÔ∏è Against: ${battle.against}</div>` : ''}
          <div class="history-stats">
            <div class="stat-item">
              <div class="stat-label">Outcome</div>
              <div class="stat-value">${getOutcomeEmoji(battle.outcome)} ${battle.outcome}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Total Sent</div>
              <div class="stat-value">${(battle.troopsSent.army + battle.troopsSent.marines + battle.troopsSent.airforce).toLocaleString()}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Total Lost</div>
              <div class="stat-value">${(battle.troopsLost.army + battle.troopsLost.marines + battle.troopsLost.airforce).toLocaleString()}</div>
          </div>
            <div class="stat-item">
              <div class="stat-label">Loss Rate</div>
              <div class="stat-value">${battle.troopsSent.army + battle.troopsSent.marines + battle.troopsSent.airforce > 0 ? 
                (((battle.troopsLost.army + battle.troopsLost.marines + battle.troopsLost.airforce) / 
                  (battle.troopsSent.army + battle.troopsSent.marines + battle.troopsSent.airforce)) * 100).toFixed(1) : 0}%</div>
          </div>
          </div>
          ${battle.notes ? `<p style="margin-top: 10px; color: #9ca3af; font-style: italic;">"${battle.notes}"</p>` : ''}
      </div>
    `).join('');
  }
  
    function getOutcomeEmoji(outcome) {
      switch(outcome) {
        case 'victory': return 'üèÜ';
        case 'defeat': return 'üíÄ';
        case 'draw': return 'ü§ù';
        default: return '‚ùì';
      }
    }

    function clearForm() {
      document.getElementById('battleName').value = '';
      document.getElementById('battleDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('battleAgainst').value = '';
      document.getElementById('armySent').value = '';
      document.getElementById('marinesSent').value = '';
      document.getElementById('airforceSent').value = '';
      document.getElementById('armyLost').value = '';
      document.getElementById('marinesLost').value = '';
      document.getElementById('airforceLost').value = '';
      document.getElementById('armySurvived').value = '';
      document.getElementById('marinesSurvived').value = '';
      document.getElementById('airforceSurvived').value = '';
      document.getElementById('enemyArmySent').value = '';
      document.getElementById('enemyMarinesSent').value = '';
      document.getElementById('enemyAirforceSent').value = '';
      document.getElementById('enemyFromCalculator').checked = false;
      document.getElementById('battleOutcome').value = 'victory';
      document.getElementById('battleNotes').value = '';
      document.getElementById('resultsDisplay').style.display = 'none';
    }

    function clearHistory() {
      if (confirm('Are you sure you want to clear all battle history? This cannot be undone.')) {
        localStorage.removeItem('battleHistory');
        displayHistory();
      }
    }
    
    // Notify other pages of new battle data for counter strategy updates
    function notifyCounterStrategyUpdate(battleData) {
      // Store a flag that new battle data is available
      localStorage.setItem('counterStrategyUpdateNeeded', JSON.stringify({
        timestamp: Date.now(),
        battleId: battleData.id,
        enemyComposition: {
          army: battleData.enemyTroops.army,
          marines: battleData.enemyTroops.marines,
          airforce: battleData.enemyTroops.airforce
        },
        outcome: battleData.outcome,
        lossRate: calculateLossRate(battleData)
      }));
      
      // Dispatch custom event for real-time updates if control point page is open
      window.dispatchEvent(new CustomEvent('battleDataUpdated', {
        detail: battleData
      }));
    }
    
    function calculateLossRate(battle) {
      const totalSent = battle.troopsSent.army + battle.troopsSent.marines + battle.troopsSent.airforce;
      const totalLost = battle.troopsLost.army + battle.troopsLost.marines + battle.troopsLost.airforce;
      return totalSent > 0 ? (totalLost / totalSent) * 100 : 0;
    }

    function editBattle() {
      // Enable editing of all form fields
      const fields = [
        'battleName', 'battleDate', 'armySent', 'marinesSent', 'airforceSent',
        'armyLost', 'marinesLost', 'airforceLost', 'battleOutcome', 'battleNotes'
      ];
      
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.disabled = false;
          field.style.opacity = '1';
          field.style.borderColor = '#3b82f6'; // Highlight editable fields
        }
      });
      
      // Show success message
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '‚úÖ Editing Enabled';
      button.classList.add('success');
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('success');
        // Reset border colors after 3 seconds
        fields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.style.borderColor = '';
          }
        });
      }, 3000);
    }

    function goToTroopSwap() {
      // Navigate to troop swap calculator
      window.location.href = 'troop_swap_calculator.html';
    }

    function loadFromCalculator() {
      // Try to get data from the control point calculator
      const calculatorData = localStorage.getItem('lastCalculatorData');
      if (calculatorData) {
        const data = JSON.parse(calculatorData);
        document.getElementById('armySent').value = data.army || '';
        document.getElementById('marinesSent').value = data.marines || '';
        document.getElementById('airforceSent').value = data.airforce || '';
        calculateSurvivors();
        
        // Show success message
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úÖ Loaded!';
        button.classList.add('success');
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('success');
        }, 2000);
      } else {
        alert('No calculator data found. Please use the Control Point Calculator first to calculate your troop deployment.');
      }
    }

    function exportToCSV() {
      const history = JSON.parse(localStorage.getItem('battleHistory') || '[]');
      
      if (history.length === 0) {
        alert('No battle data to export. Please save some battle results first.');
        return;
      }

      // Create CSV header
      const headers = [
        'Battle Name',
        'Date',
        'Against',
        // Calculator Input Data
        'Calculator: Troops to Use',
        'Calculator: Army %',
        'Calculator: Marines %',
        'Calculator: Air Force %',
        'Calculator: Remaining Troops',
        // Battle Results
        'Army Sent',
        'Marines Sent', 
        'Air Force Sent',
        'Total Sent',
        'Army Lost',
        'Marines Lost',
        'Air Force Lost',
        'Total Lost',
        'Army Survived',
        'Marines Survived',
        'Air Force Survived',
        'Total Survived',
        'Loss Rate (%)',
        'Enemy Army',
        'Enemy Marines',
        'Enemy Air Force',
        'Total Enemy Troops',
        'Enemy From Calculator',
        'Outcome',
        'Notes'
      ];

      // Create CSV rows
      const rows = history.map(battle => {
        const totalSent = battle.troopsSent.army + battle.troopsSent.marines + battle.troopsSent.airforce;
        const totalLost = battle.troopsLost.army + battle.troopsLost.marines + battle.troopsLost.airforce;
        const totalSurvived = battle.troopsSurvived.army + battle.troopsSurvived.marines + battle.troopsSurvived.airforce;
        const lossRate = totalSent > 0 ? ((totalLost / totalSent) * 100).toFixed(2) : 0;

        // Get calculator input data (with fallbacks for older entries)
        const calcInput = battle.calculatorInput || {};
        
        return [
          `"${battle.name}"`,
          battle.date,
          `"${battle.against || 'Unknown Enemy'}"`,
          // Calculator Input Data
          calcInput.troopsToUse || '',
          calcInput.armyPercentage || '',
          calcInput.marinesPercentage || '',
          calcInput.airforcePercentage || '',
          calcInput.remainingTroops || '',
          // Battle Results
          battle.troopsSent.army,
          battle.troopsSent.marines,
          battle.troopsSent.airforce,
          totalSent,
          battle.troopsLost.army,
          battle.troopsLost.marines,
          battle.troopsLost.airforce,
          totalLost,
          battle.troopsSurvived.army,
          battle.troopsSurvived.marines,
          battle.troopsSurvived.airforce,
          totalSurvived,
          lossRate,
          battle.enemyTroops?.army || 0,
          battle.enemyTroops?.marines || 0,
          battle.enemyTroops?.airforce || 0,
          (battle.enemyTroops?.army || 0) + (battle.enemyTroops?.marines || 0) + (battle.enemyTroops?.airforce || 0),
          battle.enemyFromCalculator ? 'Yes' : 'No',
          battle.outcome,
          `"${battle.notes || ''}"`
        ];
      });

      // Combine headers and rows
      const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');

      // Create and download file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `battle_results_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // Show success message
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '‚úÖ Exported!';
      button.classList.add('success');
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('success');
      }, 2000);
    }

    // Auto-load calculator data on page load
    function autoLoadCalculatorData() {
      const calculatorData = localStorage.getItem('lastCalculatorData');
      if (calculatorData) {
        const data = JSON.parse(calculatorData);
        // Only auto-load if the data is recent (within last 5 minutes)
        if (Date.now() - data.timestamp < 300000) {
          document.getElementById('armySent').value = data.army || '';
          document.getElementById('marinesSent').value = data.marines || '';
          document.getElementById('airforceSent').value = data.airforce || '';
          calculateSurvivors();
          
          // Show a subtle notification that data was loaded
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; background: #10b981; color: white; 
            padding: 10px 15px; border-radius: 5px; z-index: 1000; font-size: 14px;
          `;
          notification.textContent = '‚úÖ Calculator data loaded automatically';
          document.body.appendChild(notification);
          setTimeout(() => document.body.removeChild(notification), 3000);
        }
      }
    }

    function toggleEnemyTroopsSource() {
      const checkbox = document.getElementById('enemyFromCalculator');
      const enemyInputs = ['enemyArmySent', 'enemyMarinesSent', 'enemyAirforceSent'];
      
      if (checkbox.checked) {
        // Load enemy troops from calculator data
        const calculatorData = JSON.parse(localStorage.getItem('lastCalculatorData') || '{}');
        
        // For now, we'll use placeholder values since we don't have enemy data from calculator
        // In a real implementation, this would come from the enemy force distribution section
        document.getElementById('enemyArmySent').value = calculatorData.enemyArmy || 0;
        document.getElementById('enemyMarinesSent').value = calculatorData.enemyMarines || 0;
        document.getElementById('enemyAirforceSent').value = calculatorData.enemyAirforce || 0;
        
        // Disable manual input
        enemyInputs.forEach(id => {
          document.getElementById(id).disabled = true;
        });
      } else {
        // Enable manual input and clear values
        enemyInputs.forEach(id => {
          document.getElementById(id).disabled = false;
          document.getElementById(id).value = '';
        });
      }
    }

    function loadKnownEnemies() {
      const knownEnemies = JSON.parse(localStorage.getItem('knownEnemies') || '[]');
      const select = document.getElementById('battleAgainst');
      
      // Clear existing options except the first one
      select.innerHTML = '<option value="">Select enemy or add new...</option>';
      
      // Add known enemies to dropdown
      knownEnemies.forEach(enemy => {
        const option = document.createElement('option');
        option.value = enemy.name;
        option.textContent = enemy.name;
        select.appendChild(option);
      });
    }

    function handleEnemySelection() {
      const selectedEnemy = document.getElementById('battleAgainst').value;
      if (selectedEnemy) {
        // Load enemy data and auto-populate enemy troops if available
        const knownEnemies = JSON.parse(localStorage.getItem('knownEnemies') || '[]');
        const enemy = knownEnemies.find(e => e.name === selectedEnemy);
        
        if (enemy) {
          // Auto-populate enemy troops from known enemy data
          const totalArmy = (enemy.troops.army.t1 || 0) + (enemy.troops.army.t2 || 0) + (enemy.troops.army.t3 || 0) + (enemy.troops.army.t4 || 0);
          const totalMarines = (enemy.troops.commandos.t1 || 0) + (enemy.troops.commandos.t2 || 0) + (enemy.troops.commandos.t3 || 0) + (enemy.troops.commandos.t4 || 0);
          const totalAirforce = (enemy.troops.airforce.t1 || 0) + (enemy.troops.airforce.t2 || 0) + (enemy.troops.airforce.t3 || 0) + (enemy.troops.airforce.t4 || 0);
          
          document.getElementById('enemyArmySent').value = totalArmy;
          document.getElementById('enemyMarinesSent').value = totalMarines;
          document.getElementById('enemyAirforceSent').value = totalAirforce;
          
          // Check the "from calculator" checkbox since we're using known data
          document.getElementById('enemyFromCalculator').checked = true;
          toggleEnemyTroopsSource();
        }
      }
    }

    function addNewEnemy() {
      const enemyName = prompt('Enter new enemy name:');
      if (enemyName && enemyName.trim()) {
        const select = document.getElementById('battleAgainst');
        const option = document.createElement('option');
        option.value = enemyName.trim();
        option.textContent = enemyName.trim();
        option.selected = true;
        select.appendChild(option);
        
        // Clear enemy troops since this is a new enemy
        document.getElementById('enemyArmySent').value = '';
        document.getElementById('enemyMarinesSent').value = '';
        document.getElementById('enemyAirforceSent').value = '';
        document.getElementById('enemyFromCalculator').checked = false;
        toggleEnemyTroopsSource();
      }
    }

    function showEnemyAnalytics() {
      const history = JSON.parse(localStorage.getItem('battleHistory') || '[]');
      const knownEnemies = JSON.parse(localStorage.getItem('knownEnemies') || '[]');
      
      if (history.length === 0) {
        alert('No battle history available for analytics.');
        return;
      }
      
      // Group battles by enemy
      const enemyStats = {};
      history.forEach(battle => {
        const enemyName = battle.against || 'Unknown Enemy';
        if (!enemyStats[enemyName]) {
          enemyStats[enemyName] = {
            name: enemyName,
            battles: [],
            victories: 0,
            defeats: 0,
            draws: 0,
            totalSent: 0,
            totalLost: 0,
            avgLossRate: 0
          };
        }
        
        enemyStats[enemyName].battles.push(battle);
        if (battle.outcome === 'victory') enemyStats[enemyName].victories++;
        else if (battle.outcome === 'defeat') enemyStats[enemyName].defeats++;
        else enemyStats[enemyName].draws++;
        
        const totalSent = battle.troopsSent.army + battle.troopsSent.marines + battle.troopsSent.airforce;
        const totalLost = battle.troopsLost.army + battle.troopsLost.marines + battle.troopsLost.airforce;
        enemyStats[enemyName].totalSent += totalSent;
        enemyStats[enemyName].totalLost += totalLost;
      });
      
      // Calculate average loss rates
      Object.values(enemyStats).forEach(stats => {
        stats.avgLossRate = stats.totalSent > 0 ? (stats.totalLost / stats.totalSent * 100).toFixed(1) : 0;
      });
      
      // Create analytics display
      let analyticsHTML = '<div style="background: #1f2937; padding: 20px; border-radius: 10px; margin: 20px 0;">';
      analyticsHTML += '<h3 style="color: #fbbf24; margin-top: 0;">üìä Enemy Performance Analytics</h3>';
      
      Object.values(enemyStats).forEach(stats => {
        const winRate = stats.battles.length > 0 ? (stats.victories / stats.battles.length * 100).toFixed(1) : 0;
        const isKnownEnemy = knownEnemies.some(e => e.name === stats.name);
        
        analyticsHTML += `<div style="background: #374151; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid ${isKnownEnemy ? '#10b981' : '#6b7280'};">`;
        analyticsHTML += `<h4 style="color: #fbbf24; margin-top: 0;">${stats.name} ${isKnownEnemy ? 'üìã' : ''}</h4>`;
        analyticsHTML += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; color: #d1d5db;">`;
        analyticsHTML += `<div><strong>Battles:</strong> ${stats.battles.length}</div>`;
        analyticsHTML += `<div><strong>Win Rate:</strong> ${winRate}%</div>`;
        analyticsHTML += `<div><strong>Victories:</strong> ${stats.victories}</div>`;
        analyticsHTML += `<div><strong>Defeats:</strong> ${stats.defeats}</div>`;
        analyticsHTML += `<div><strong>Draws:</strong> ${stats.draws}</div>`;
        analyticsHTML += `<div><strong>Avg Loss Rate:</strong> ${stats.avgLossRate}%</div>`;
        analyticsHTML += `</div></div>`;
      });
      
      analyticsHTML += '</div>';
      
      // Show in a modal or replace history display
      const historyContainer = document.getElementById('battleHistory');
      const originalContent = historyContainer.innerHTML;
      historyContainer.innerHTML = analyticsHTML + '<button onclick="displayHistory()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 10px 0;">‚Üê Back to Battle History</button>';
    }

    function loadKnownEnemies() {
      const enemies = JSON.parse(localStorage.getItem('knownEnemies') || '[]');
      const select = document.getElementById('battleAgainst');
      
      // Clear existing options except the first one
      while (select.children.length > 1) {
        select.removeChild(select.lastChild);
      }
      
      // Add enemies from known enemies database
      enemies.forEach(enemy => {
        const option = document.createElement('option');
        option.value = enemy.name;
        option.textContent = enemy.name;
        select.appendChild(option);
      });
    }

    function handleEnemySelection() {
      const selectedEnemy = document.getElementById('battleAgainst').value;
      if (!selectedEnemy) return;
      
      // Try to load enemy data from known enemies
      const enemies = JSON.parse(localStorage.getItem('knownEnemies') || '[]');
      const enemy = enemies.find(e => e.name === selectedEnemy);
      
      if (enemy && enemy.troops) {
        // Auto-fill enemy troop data if available
        const totalEnemyTroops = 
          enemy.troops.army.t1 + enemy.troops.army.t2 + enemy.troops.army.t3 + enemy.troops.army.t4 +
          enemy.troops.commandos.t1 + enemy.troops.commandos.t2 + enemy.troops.commandos.t3 + enemy.troops.commandos.t4 +
          enemy.troops.airforce.t1 + enemy.troops.airforce.t2 + enemy.troops.airforce.t3 + enemy.troops.airforce.t4 +
          enemy.troops.navy.t1 + enemy.troops.navy.t2 + enemy.troops.navy.t3 + enemy.troops.navy.t4;
        
        if (totalEnemyTroops > 0) {
          // Calculate approximate distribution (simplified to 3 categories)
          const armyTotal = enemy.troops.army.t1 + enemy.troops.army.t2 + enemy.troops.army.t3 + enemy.troops.army.t4;
          const marinesTotal = enemy.troops.commandos.t1 + enemy.troops.commandos.t2 + enemy.troops.commandos.t3 + enemy.troops.commandos.t4;
          const airforceTotal = enemy.troops.airforce.t1 + enemy.troops.airforce.t2 + enemy.troops.airforce.t3 + enemy.troops.airforce.t4;
          
          document.getElementById('enemyArmySent').value = armyTotal;
          document.getElementById('enemyMarinesSent').value = marinesTotal;
          document.getElementById('enemyAirforceSent').value = airforceTotal;
          
          showToast('Enemy data loaded from Known Enemies database', 'success');
        }
      }
    }

    function addNewEnemy() {
      const enemyName = prompt('Enter enemy name:');
      if (enemyName && enemyName.trim()) {
        const select = document.getElementById('battleAgainst');
        const option = document.createElement('option');
        option.value = enemyName.trim();
        option.textContent = enemyName.trim();
        select.appendChild(option);
        select.value = enemyName.trim();
        
        showToast('New enemy added to list', 'success');
      }
    }

    function toggleEnemyTroopsSource() {
      const checkbox = document.getElementById('enemyFromCalculator');
      const enemyInputs = ['enemyArmySent', 'enemyMarinesSent', 'enemyAirforceSent'];
      
      if (checkbox.checked) {
        // Try to load from calculator data
        const calculatorData = localStorage.getItem('lastCalculatorData');
        if (calculatorData) {
          const data = JSON.parse(calculatorData);
          document.getElementById('enemyArmySent').value = data.army || '';
          document.getElementById('enemyMarinesSent').value = data.marines || '';
          document.getElementById('enemyAirforceSent').value = data.airforce || '';
          
          // Disable manual editing
          enemyInputs.forEach(id => {
            document.getElementById(id).disabled = true;
            document.getElementById(id).style.opacity = '0.6';
          });
          
          showToast('Enemy troops loaded from calculator', 'success');
        } else {
          checkbox.checked = false;
          showToast('No calculator data found', 'error');
        }
      } else {
        // Enable manual editing
        enemyInputs.forEach(id => {
          document.getElementById(id).disabled = false;
          document.getElementById(id).style.opacity = '1';
        });
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
      toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: ${bgColor}; color: white;
        padding: 12px 20px; border-radius: 8px; z-index: 1000; font-weight: bold;
        animation: slideIn 0.3s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 3000);
    }

    // Add CSS for toast animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);

    // Load history and auto-load calculator data on page load
    displayHistory();
    autoLoadCalculatorData();
    loadKnownEnemies();

    // Add input validation
    document.addEventListener('DOMContentLoaded', function() {
      const numberInputs = document.querySelectorAll('input[type="number"]');
      numberInputs.forEach(input => {
        input.addEventListener('input', function() {
          // Prevent negative values
          if (this.value < 0) this.value = 0;
          
          // Cross-validation: survivors can't exceed sent troops
          if (this.id.includes('Lost')) {
            const troopType = this.id.replace('Lost', '');
            const sentInput = document.getElementById(troopType + 'Sent');
            const survivedInput = document.getElementById(troopType + 'Survived');
            
            if (sentInput && survivedInput) {
              const sent = parseInt(sentInput.value) || 0;
              const lost = parseInt(this.value) || 0;
              
              if (lost > sent) {
                this.value = sent;
                showToast(`Losses cannot exceed troops sent (${sent.toLocaleString()})`, 'error');
              }
            }
          }
          
          calculateSurvivors();
        });
      });
    });
</script>
  <script src="../src/scripts/components/shared-nav.js"></script>
</body>
</html>
