<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Troop Swap Calculator - Troop Tools</title>
  <link rel="stylesheet" href="../src/styles/styles.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: white;
    }

    .container {
      background: #16213e;
      padding: 30px;
      border-radius: 15px;
      border: 1px solid #333;
    }

    h1 {
      text-align: center;
      color: #64b5f6;
      margin-bottom: 30px;
    }

    .section {
      background: #0f3460;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .section h2 {
      color: #64b5f6;
      margin-top: 0;
      margin-bottom: 15px;
    }

    .section h3 {
      color: #64b5f6;
      margin-top: 0;
      margin-bottom: 15px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .flex-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .flex-row label {
      font-weight: bold;
      white-space: nowrap;
    }

    input[type="number"], input[type="text"] {
      padding: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #2a2a3e;
      color: white;
      font-size: 14px;
    }

    input[type="number"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #64b5f6;
      box-shadow: 0 0 5px rgba(100, 181, 246, 0.3);
    }

    .troop-label {
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
    }

    .troop-label.army {
      background: #ff4d4d;
      color: white;
    }

    .troop-label.marines {
      background: #4da6ff;
      color: white;
    }

    .troop-label.airforce {
      background: #33cc33;
      color: white;
    }

    button {
      background: #64b5f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    button:hover {
      background: #5a9fd4;
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    button.secondary {
      background: #6b7280;
    }

    button.secondary:hover {
      background: #5a6268;
    }

    .small {
      font-size: 0.9em;
      color: #ccc;
      margin-top: 10px;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .pill.ok {
      background: #10b981;
      color: white;
    }

    .tooltip {
      position: absolute;
      background: #1a1a2e;
      color: #10b981;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 1000;
    }

    .tooltip.show {
      opacity: 1;
    }

    .bar-container {
      display: flex;
      height: 20px;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      margin: 5px 0;
    }

    .bar {
      height: 100%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }

    .bar.army {
      background: #ff4d4d;
    }

    .bar.marines {
      background: #4da6ff;
    }

    .bar.airforce {
      background: #33cc33;
    }

    .bar.orig {
      opacity: 0.7;
    }

    .bar-row {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .player {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #333;
      margin-bottom: 15px;
    }

    .player strong {
      color: #64b5f6;
    }

    .name-input {
      flex: 1;
      min-width: 150px;
    }

    .troop-count {
      margin: 10px 0;
      padding: 8px;
      background: #0f3460;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }

    .copy-player-btn {
      background: #10b981;
      font-size: 12px;
      padding: 6px 12px;
    }

    .copy-player-btn:hover {
      background: #059669;
    }

    .remove-player-btn {
      background: #ef4444;
      font-size: 12px;
      padding: 6px 12px;
    }

    .remove-player-btn:hover {
      background: #dc2626;
    }

    @media (max-width: 768px) {
      .flex-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .flex-row input {
        width: 100%;
      }
      
      .troop-label {
        align-self: flex-start;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>⚔️ Troop Swap Calculator</h1>

    <div class="section" aria-live="polite">
      <h2>Initial Alliance Ratio <span id="initStatus" class="pill ok" style="display:none">normalized</span></h2>
      <div class="flex-row">
        <span class="troop-label army">Army</span><input type="number" id="initArmy" value="34" min="0" max="100" inputmode="numeric" />
        <span class="troop-label marines">Marines</span><input type="number" id="initMarines" value="33" min="0" max="100" inputmode="numeric" />
        <span class="troop-label airforce">Air Force</span><input type="number" id="initAirforce" value="33" min="0" max="100" inputmode="numeric" />
      </div>
      <p class="small">Total Deployment: <strong id="totalDeploymentText">6,462,500</strong> troops</p>
    </div>

    <div class="section">
      <div class="flex-row" style="justify-content:space-between; gap:10px;">
        <h2>Swapped Players</h2>
        <div class="flex-row" style="gap:6px;">
          <button id="addBtn">Add Player Swap</button>
          <button class="secondary" id="removeBtn" disabled>Remove Last</button>
        </div>
      </div>
      <div id="playersContainer"></div>
    </div>

    <div class="section">
      <h2>Manual Alliance Total Override</h2>
      <div class="flex-row">
        <label for="currentTotal">Current Total Deployed:</label>
        <input type="number" id="currentTotal" value="6462500" min="0" inputmode="numeric" style="width: 200px; font-size: 16px; font-weight: bold;" />
        <button id="calculateNeededBtn">Calculate Needed</button>
      </div>
      <div id="neededResult" style="margin-top:8px; position: relative;">
        <span id="neededTooltip" class="tooltip">Copied!</span>
      </div>
      <p class="small">Uses the <em>initial alliance ratio</em> to suggest how to fill the gap.</p>
    </div>

    <div class="flex-row" style="gap:8px; margin-bottom:8px;">
      <button id="calculateBtn">Calculate New Ratio</button>
      <button class="secondary" id="resetBtn">Clear Chart</button>
    </div>

    <div class="section result" id="result" aria-live="polite"></div>

    <div class="section">
      <h2>Alliance Ratio Visualization</h2>
      <div class="flex-row" style="gap:15px; margin-bottom:15px;">
        <label><input type="checkbox" id="showOriginal" checked> Original</label>
        <label><input type="checkbox" id="showBackground" checked> Background</label>
      </div>
      
      <div class="bar-row">Army</div>
      <div class="bar-container">
        <div class="bar army orig" id="barArmyOrig" style="width:0%"></div>
        <div class="bar army" id="barArmyNew" style="width:0%"></div>
      </div>
      
      <div class="bar-row">Marines</div>
      <div class="bar-container">
        <div class="bar marines orig" id="barMarinesOrig" style="width:0%"></div>
        <div class="bar marines" id="barMarinesNew" style="width:0%"></div>
      </div>

      <div class="bar-row">Air Force</div>
      <div class="bar-container">
        <div class="bar airforce orig" id="barAirforceOrig" style="width:0%"></div>
        <div class="bar airforce" id="barAirforceNew" style="width:0%"></div>
      </div>
    </div>
  </div>

  <script>
    // Troop Swap Calculator Implementation
    const TOTAL_DEPLOYMENT = 6462500;
    const MAX_PLAYERS = 8;
    let playerCount = 0;

    // Security: Input sanitization
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/[<>\"'&]/g, function(match) {
        const escape = {
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#x27;',
          '&': '&amp;'
        };
        return escape[match];
      });
    }

    // Utility functions
    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
    function num(v, d=0){ const n = Number(String(v).trim()); return Number.isFinite(n) ? n : d; }

    // Normalize three percentages to sum exactly 100 using largest remainder
    function normalizeTriple(a, m, f){
      a = clamp(Math.trunc(num(a)), 0, 100);
      m = clamp(Math.trunc(num(m)), 0, 100);
      f = clamp(Math.trunc(num(f)), 0, 100);
      const sum = a + m + f;
      if (sum === 100) return { a, m, f, normalized:false };
      if (sum === 0) return { a:34, m:33, f:33, normalized:true };
      
      const scale = 100 / sum;
      const aa = Math.floor(a * scale);
      const mm = Math.floor(m * scale);
      const ff = Math.floor(f * scale);
      let assigned = aa + mm + ff;
      let parts = [
        {k:'a', frac: a*scale - aa, v: aa},
        {k:'m', frac: m*scale - mm, v: mm},
        {k:'f', frac: f*scale - ff, v: ff}
      ].sort((x,y)=> y.frac - x.frac);
      while (assigned < 100) { parts[0].v++; assigned++; parts.sort((x,y)=> y.frac - x.frac); }
      const out = { a: parts.find(p=>p.k==='a').v, m: parts.find(p=>p.k==='m').v, f: parts.find(p=>p.k==='f').v, normalized:true };
      return out;
    }

    // Allocate integer counts from total by percentages exactly
    function allocateCounts(total, aPct, mPct, fPct){
      const aExact = total * aPct / 100;
      const mExact = total * mPct / 100;
      const fExact = total * fPct / 100;

      const aFloor = Math.floor(aExact);
      const mFloor = Math.floor(mExact);
      const fFloor = Math.floor(fExact);

      let assigned = aFloor + mFloor + fFloor;
      let remainder = total - assigned;

      const parts = [
        {k:'a', frac: aExact - aFloor, v: aFloor},
        {k:'m', frac: mExact - mFloor, v: mFloor},
        {k:'f', frac: fExact - fFloor, v: fFloor}
      ].sort((x,y)=> y.frac - x.frac);

      while (remainder > 0) {
        parts[0].v++;
        remainder--;
        parts.sort((x,y)=> y.frac - x.frac);
      }

      return {
        a: parts.find(p=>p.k==='a').v,
        m: parts.find(p=>p.k==='m').v,
        f: parts.find(p=>p.k==='f').v
      };
    }

    // Initialize page
    function init() {
      updateInitialRatio();
      updateBars();
      
      // Add event listeners
      document.getElementById('initArmy').addEventListener('input', updateInitialRatio);
      document.getElementById('initMarines').addEventListener('input', updateInitialRatio);
      document.getElementById('initAirforce').addEventListener('input', updateInitialRatio);
      document.getElementById('addBtn').addEventListener('click', addPlayer);
      document.getElementById('removeBtn').addEventListener('click', removeLastPlayer);
      document.getElementById('calculateBtn').addEventListener('click', calculateNewRatio);
      document.getElementById('resetBtn').addEventListener('click', resetChart);
      document.getElementById('calculateNeededBtn').addEventListener('click', calculateNeeded);
      document.getElementById('currentTotal').addEventListener('input', calculateNeeded);
      document.getElementById('showOriginal').addEventListener('change', updateBars);
      document.getElementById('showBackground').addEventListener('change', updateBars);
    }

    function updateInitialRatio() {
      const a = num(document.getElementById('initArmy').value);
      const m = num(document.getElementById('initMarines').value);
      const f = num(document.getElementById('initAirforce').value);
      
      // Validate input ranges
      if (a < 0 || m < 0 || f < 0) {
        showError('Percentages cannot be negative');
        return;
      }
      
      if (a > 100 || m > 100 || f > 100) {
        showError('Individual percentages cannot exceed 100%');
        return;
      }
      
      const norm = normalizeTriple(a, m, f);
      
      if (norm.normalized) {
        document.getElementById('initArmy').value = norm.a;
        document.getElementById('initMarines').value = norm.m;
        document.getElementById('initAirforce').value = norm.f;
        document.getElementById('initStatus').style.display = 'inline';
        showSuccess('Ratios automatically normalized to 100%');
      } else {
        document.getElementById('initStatus').style.display = 'none';
      }
      
      updateBars();
    }

    function addPlayer() {
      if (playerCount >= MAX_PLAYERS) {
        showError('Maximum 8 players allowed');
        return;
      }
      
      playerCount++;
      const container = document.getElementById('playersContainer');
      
      const playerDiv = document.createElement('div');
      playerDiv.className = 'player';
      playerDiv.id = `player${playerCount}`;
      
      playerDiv.innerHTML = `
        <div class="flex-row">
          <strong>Player ${playerCount}:</strong>
          <input type="text" class="name-input" placeholder="Player name" />
          <button class="copy-player-btn" onclick="copyPlayer(${playerCount})">Copy</button>
          <button class="remove-player-btn" onclick="removePlayer(${playerCount})">Remove</button>
        </div>
        <div class="flex-row">
          <span class="troop-label army">Army</span><input type="number" class="army-input" value="0" min="0" />
          <span class="troop-label marines">Marines</span><input type="number" class="marines-input" value="0" min="0" />
          <span class="troop-label airforce">Air Force</span><input type="number" class="airforce-input" value="0" min="0" />
        </div>
        <div class="troop-count" id="troopCount${playerCount}">Total: 0 troops</div>
      `;
      
      container.appendChild(playerDiv);
      
      // Add event listeners for auto-calculation
      const inputs = playerDiv.querySelectorAll('input[type="number"]');
      inputs.forEach(input => {
        input.addEventListener('input', () => updatePlayerTotal(playerCount));
      });
      
      document.getElementById('removeBtn').disabled = false;
      updatePlayerTotal(playerCount);
    }

    function removeLastPlayer() {
      if (playerCount === 0) return;
      
      const playerDiv = document.getElementById(`player${playerCount}`);
      if (playerDiv) {
        playerDiv.remove();
      }
      
      playerCount--;
      
      if (playerCount === 0) {
        document.getElementById('removeBtn').disabled = true;
      }
    }

    function removePlayer(id) {
      const playerDiv = document.getElementById(`player${id}`);
      if (playerDiv) {
        playerDiv.remove();
      }
      
      // Renumber remaining players
      const container = document.getElementById('playersContainer');
      const players = container.querySelectorAll('.player');
      playerCount = players.length;
      
      players.forEach((player, index) => {
        const newId = index + 1;
        player.id = `player${newId}`;
        player.querySelector('strong').textContent = `Player ${newId}:`;
        player.querySelector('.copy-player-btn').setAttribute('onclick', `copyPlayer(${newId})`);
        player.querySelector('.remove-player-btn').setAttribute('onclick', `removePlayer(${newId})`);
        player.querySelector('.troop-count').id = `troopCount${newId}`;
      });
      
      if (playerCount === 0) {
        document.getElementById('removeBtn').disabled = true;
      }
    }

    function updatePlayerTotal(playerId) {
      const playerDiv = document.getElementById(`player${playerId}`);
      if (!playerDiv) return;
      
      const armyInput = playerDiv.querySelector('.army-input');
      const marinesInput = playerDiv.querySelector('.marines-input');
      const airforceInput = playerDiv.querySelector('.airforce-input');
      
      const army = num(armyInput.value);
      const marines = num(marinesInput.value);
      const airforce = num(airforceInput.value);
      const total = army + marines + airforce;
      
      const countDiv = document.getElementById(`troopCount${playerId}`);
      countDiv.textContent = `Total: ${total.toLocaleString()} troops`;
    }

    function copyPlayer(playerId) {
      const playerDiv = document.getElementById(`player${playerId}`);
      if (!playerDiv) return;
      
      const nameInput = playerDiv.querySelector('.name-input');
      const armyInput = playerDiv.querySelector('.army-input');
      const marinesInput = playerDiv.querySelector('.marines-input');
      const airforceInput = playerDiv.querySelector('.airforce-input');
      
      const name = nameInput.value || `Player ${playerId}`;
      const army = num(armyInput.value);
      const marines = num(marinesInput.value);
      const airforce = num(airforceInput.value);
      const total = army + marines + airforce;
      
      const text = `${name}: Army ${army.toLocaleString()}, Marines ${marines.toLocaleString()}, Air Force ${airforce.toLocaleString()} (Total: ${total.toLocaleString()})`;
      
      navigator.clipboard.writeText(text).then(() => {
        showSuccess('Player data copied to clipboard!');
      }).catch(() => {
        showError('Failed to copy to clipboard');
      });
    }

    function calculateNewRatio() {
      const players = document.querySelectorAll('.player');
      if (players.length === 0) {
        showError('Add at least one player to calculate new ratio');
        return;
      }
      
      let totalArmy = 0, totalMarines = 0, totalAirforce = 0;
      
      players.forEach(player => {
        const army = num(player.querySelector('.army-input').value);
        const marines = num(player.querySelector('.marines-input').value);
        const airforce = num(player.querySelector('.airforce-input').value);
        
        totalArmy += army;
        totalMarines += marines;
        totalAirforce += airforce;
      });
      
      const grandTotal = totalArmy + totalMarines + totalAirforce;
      
      if (grandTotal === 0) {
        showError('Enter troop counts for at least one player');
        return;
      }
      
      const armyPct = Math.round((totalArmy / grandTotal) * 100);
      const marinesPct = Math.round((totalMarines / grandTotal) * 100);
      const airforcePct = Math.round((totalAirforce / grandTotal) * 100);
      
      // Normalize to exactly 100%
      const norm = normalizeTriple(armyPct, marinesPct, airforcePct);
      
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `
        <h3>New Alliance Ratio</h3>
        <div class="flex-row" style="justify-content: center; gap: 20px; margin: 15px 0;">
          <div><span class="troop-label army">Army</span> ${norm.a}%</div>
          <div><span class="troop-label marines">Marines</span> ${norm.m}%</div>
          <div><span class="troop-label airforce">Air Force</span> ${norm.f}%</div>
        </div>
        <p><strong>Total Swapped Troops:</strong> ${grandTotal.toLocaleString()}</p>
        <p class="small">Based on ${players.length} player swap(s)</p>
      `;
      
      updateBars(norm.a, norm.m, norm.f);
    }

    function calculateNeeded() {
      const currentTotal = num(document.getElementById('currentTotal').value);
      if (currentTotal <= 0) {
        document.getElementById('neededResult').innerHTML = '';
        return;
      }
      
      const needed = TOTAL_DEPLOYMENT - currentTotal;
      if (needed <= 0) {
        document.getElementById('neededResult').innerHTML = '<p style="color: #10b981;">✅ Deployment complete!</p>';
        return;
      }
      
      const a = num(document.getElementById('initArmy').value);
      const m = num(document.getElementById('initMarines').value);
      const f = num(document.getElementById('initAirforce').value);
      
      const norm = normalizeTriple(a, m, f);
      const counts = allocateCounts(needed, norm.a, norm.m, norm.f);
      
      const resultText = `Army: ${counts.a.toLocaleString()}, Marines: ${counts.m.toLocaleString()}, Air Force: ${counts.f.toLocaleString()}`;
      
      document.getElementById('neededResult').innerHTML = `
        <p><strong>Still needed (${needed.toLocaleString()} troops):</strong></p>
        <div class="input-with-button">
          <input type="text" value="${resultText}" readonly style="font-family: monospace;" />
          <button class="copy-button" onclick="copyNeeded('${resultText}')">Copy</button>
        </div>
      `;
    }

    function copyNeeded(text) {
      navigator.clipboard.writeText(text).then(() => {
        const tooltip = document.getElementById('neededTooltip');
        tooltip.classList.add('show');
        setTimeout(() => tooltip.classList.remove('show'), 1500);
      });
    }

    function updateBars(newA, newM, newF) {
      const showOriginal = document.getElementById('showOriginal').checked;
      const showBackground = document.getElementById('showBackground').checked;
      
      // Original ratios
      const origA = num(document.getElementById('initArmy').value);
      const origM = num(document.getElementById('initMarines').value);
      const origF = num(document.getElementById('initAirforce').value);
      
      // New ratios (if provided)
      const a = newA !== undefined ? newA : origA;
      const m = newM !== undefined ? newM : origM;
      const f = newF !== undefined ? newF : origF;
      
      // Update original bars
      document.getElementById('barArmyOrig').style.width = showOriginal ? `${origA}%` : '0%';
      document.getElementById('barMarinesOrig').style.width = showOriginal ? `${origM}%` : '0%';
      document.getElementById('barAirforceOrig').style.width = showOriginal ? `${origF}%` : '0%';
      
      // Update new bars
      document.getElementById('barArmyNew').style.width = `${a}%`;
      document.getElementById('barMarinesNew').style.width = `${m}%`;
      document.getElementById('barAirforceNew').style.width = `${f}%`;
      
      // Update bar text
      document.getElementById('barArmyNew').textContent = a > 5 ? `${a}%` : '';
      document.getElementById('barMarinesNew').textContent = m > 5 ? `${m}%` : '';
      document.getElementById('barAirforceNew').textContent = f > 5 ? `${f}%` : '';
      
      // Show/hide background
      const container = document.querySelector('.bar-container');
      if (container) {
        container.style.background = showBackground ? '#333' : 'transparent';
      }
    }

    function resetChart() {
      document.getElementById('result').innerHTML = '';
      updateBars();
    }

    function showError(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: #ef4444; color: white;
        padding: 12px 20px; border-radius: 8px; z-index: 1000; font-weight: bold;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 3000);
    }

    function showSuccess(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: #10b981; color: white;
        padding: 12px 20px; border-radius: 8px; z-index: 1000; font-weight: bold;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 3000);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', init);

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('../service-worker.js').then(registration => {
        console.log('SW registered: ', registration);
        
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              if (confirm('New version available! Reload to update?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
    }
  </script>
  <script src="../src/scripts/components/shared-nav.js"></script>
</body>
</html>